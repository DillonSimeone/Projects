<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Random Account Generator</title>
    <meta name="description" content="Generates random accounts using the Fetch API">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <header>
        <h1>Random Account Generator</h1>
        <input placeholder="seed">
    </header>
    <nav>
        <button onclick="previous()">Previous</button>
        <h2>Page 1</h2>
        <button onclick="next()">Next</button>

    </nav>
    <div class="accounts">
    </div>
    <script>
        const accounts = document.querySelector('.accounts')

        const data = {
            page: 1,
            results: 10,
            seed: "asd"
        }

        let canvases = [] //For blood splatter animations.

        const pictureSettings = {
            "size": 150, //Size of the canvas elements with the images in them.
            "quality": "medium" //Three options: large, medium, thumbnail. Default: thumbnail
        };

        const splatterSetting = {
            "amount": pictureSettings.size/2, //Amount of circles to spawn to make a splatter
            "angle": 5, //Spacing between circles. Bigger this is, the further the circles will travel from eachother.
            "angleXdelta": pictureSettings.size/10, //How far the circles can travel on the x-axis
            "angleYdelta": pictureSettings.size/10, //How far the circles can travel on the y-axis
            "randomness": 15, // How far the circles could travel on either axis. (Example: angleXdelta * randomness)
            "size": 5 + Math.random() * 3, //Circles starts at this then start shrinking to zero.
            "sizeDelta": 10, //The max size
            "life": 200 + Math.random() *
                50 // How long it takes to animate the circles. Automically set to 0 if size < 0.
        }

        

        function request() {
            let url = "https://randomuser.me/api/?";
            Object.keys(data).forEach(element => {
                url += `${element}=${data[element]}&`
            })
            return url.slice(0, request.length - 1)
        }

        function getAccounts() {
            fetch(request()).then(
                response => {
                    return response.json()
                }
            ).then(
                json => {
                    accounts.innerHTML = "";
                    makeCards(json).forEach(card => {
                        accounts.append(card)
                    })
                    bloodsplatters();
                }
            )
        }

        function makeCards(accounts) {
            //console.log(accounts)
            let cards = [];
            accounts.results.forEach(result => {
                let card = document.createElement('div')
                card.setAttribute("class", "cards")

                let canvas = document.createElement('canvas')
                canvas.width = pictureSettings.size
                canvas.height = pictureSettings.size
                canvas.style.borderRadius = "100px"
                canvas.onclick = function (e, canvas) {
                    canvases.forEach(object => {
                        if (object.canvas === this) {
                            let location = this.getBoundingClientRect()
                            for (var i = 0; i < splatterSetting.amount; i++) {
                                object.particles.push({
                                    x: e.clientX - location.x,
                                    y: e.clientY - location.y,
                                    angle: i * splatterSetting.angle,
                                    size: splatterSetting.size,
                                    life: splatterSetting.life
                                })
                            }
                        }
                    })
                }
                let ctx = canvas.getContext('2d')

                let image = new Image()

                switch (pictureSettings.quality) {
                    case "large":
                        image.src = result.picture.large
                        break;
                    case "medium":
                        image.src = result.picture.medium
                        break;
                    case "thumbnail":
                        image.src = result.picture.thumbnail
                        break;
                    default:
                        image.src = result.picture.thumbnail
                        break;
                }

                image.onload = function () {
                    ctx.drawImage(image, 0, 0, pictureSettings.size, pictureSettings.size)
                }

                let name = document.createElement('h1')

                let basicInfo = document.createElement('ul')
                basicInfo.setAttribute("class", "basicInfo")
                //let detailedInfo = document.createElement('ul')

                name.innerText = `${result.name.first} ${result.name.last}`

                basicInfo.append(listItem(result.email));
                basicInfo.append(listItem(result.cell))

                //detailedInfo.append(listItem(`${result.location.street}, ${result.location.city}`))
                card.append(canvas)
                card.append(name)
                card.append(basicInfo)
                cards.push(card)
                //body.append(card)
            })
            return cards
        }

        //Sets up onclick events for each bloodsplatters.
        function bloodsplatters() {
            Array.from(document.querySelectorAll("canvas")).forEach(canvas => {
                canvases.push({
                    "canvas": canvas,
                    "particles": []
                })
            })
        }

        //Animates the bloodsplatters
        let delta = 0,
            last = Date.now()



        function animateBloodsplatters() {
            delta = Date.now() - last;
            last = Date.now();
            canvases.forEach(object => {
                for (let i = 0; i < object.particles.length; i++) {
                    let p = object.particles[i];
                    p.x += Math.cos(p.angle) * splatterSetting.angleXdelta + Math.random() * splatterSetting
                        .randomness - Math.random() * splatterSetting.randomness
                    p.y += Math.sin(p.angle) * splatterSetting.angleYdelta + Math.random() * splatterSetting
                        .randomness - Math.random() * splatterSetting.randomness
                    p.life -= delta
                    p.size -= delta / splatterSetting.sizeDelta;

                    if (p.size <= 0) {
                        p.life = 0
                    }

                    if (p.life <= 0) {
                        object.particles.splice(i--, 1)
                        continue;
                    }
                }
            })
        }

        //Renders the blood bath!
        function render() {
            canvases.forEach(object => {
                let ctx = object.canvas.getContext('2d')
                ctx.strokeStyle = "rgba(0,0,0,0.5)"
                object.particles.forEach(particle => {
                    ctx.fillStyle = `rgb(${(Math.random() * 100)+140}, 0, 0)`
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size + 1, 2, Math.PI * 2, false);
                    ctx.fill();
                })
            })
        }



        //Start the loop!

        (function animloop() {
            requestAnimationFrame(animloop);
            animateBloodsplatters();
            render();
        })();


        function listItem(text) {
            let listItem = document.createElement('li')
            listItem.innerText = text;
            return listItem;
        }

        let pageNumber = document.querySelector('nav').querySelector('h2')
        let seed = document.querySelector('input')
        console.log(pageNumber)

        function next() {
            data.page += 1;
            data.seed = seed.innerText;
            pageNumber.innerHTML = `Page ${data.page}`
            canvases = [];
            getAccounts()
        }

        function previous() {
            if (data.page > 1) {
                data.page -= 1;
                data.seed = seed.innerText;
                pageNumber.innerHTML = `Page ${data.page}`
                canvases = [];
                getAccounts()
            }

        }

        //Blood splatters settings
        var options = {
            scatter: 0,
            gravity: 0.2,
            consistency: 0.04,
            pollock: false,
            burst: true,
            shade: true
        }

        getAccounts()
    </script>
</body>

</html>